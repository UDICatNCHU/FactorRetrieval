<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>判決內容 #{{ index }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .judgment-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .judgment-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .judgment-content {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 16px;
            font-family: "Arial Unicode MS", "Microsoft JhengHei", "Heiti TC", "LiHei Pro", sans-serif;
        }
        .judgment-meta {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .judgment-section {
            margin-bottom: 15px;
        }
        .judgment-section h3 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .back-link {
            display: inline-block;
            margin: 20px 0;
            padding: 10px 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 4px;
            text-decoration: none;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            overflow: auto;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        .error-message {
            color: #d9534f;
            background-color: #f2dede;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="judgment-container">
        <div class="judgment-header">
            <h1>判決內容 #{{ index }}</h1>
            <a href="{{ url_for('index') }}" class="back-link">返回搜尋</a>
        </div>

        {% if judgment %}
            <div class="judgment-meta">
                <!-- 顯示判決元數據 -->
                {% if judgment.court_name %}
                    <p><strong>法院:</strong> {{ judgment.court_name }}</p>
                {% endif %}
                
                {% if judgment.date %}
                    <p><strong>日期:</strong> {{ judgment.date }}</p>
                {% endif %}
                
                {% if judgment.case_number %}
                    <p><strong>案號:</strong> {{ judgment.case_number }}</p>
                {% endif %}

                {% if judgment.title %}
                    <p><strong>標題:</strong> {{ judgment.title }}</p>
                {% endif %}
            </div>

            <div class="judgment-content">
                {% if judgment.content %}
                    <div class="judgment-section">
                        <div id="judgment-text">{{ judgment.content|safe }}</div>
                    </div>
                {% elif judgment.full_text %}
                    <div class="judgment-section">
                        <div id="judgment-text">{{ judgment.full_text|safe }}</div>
                    </div>
                {% elif judgment.text %}
                    <div class="judgment-section">
                        <div id="judgment-text">{{ judgment.text|safe }}</div>
                    </div>
                {% else %}
                    <!-- 嘗試遍歷所有字段並顯示長度超過100的文本內容 -->
                    {% set found_content = false %}
                    {% for key, value in judgment.items() %}
                        {% if value is string and value|length > 100 %}
                            {% set found_content = true %}
                            <div class="judgment-section">
                                <h3>{{ key }}</h3>
                                <div id="judgment-text-{{ key }}">{{ value|safe }}</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if not found_content %}
                        <div class="judgment-section">
                            <h3>判決內容</h3>
                            <div id="judgment-data">{{ judgment|tojson(indent=2) }}</div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        {% else %}
            <div class="judgment-section">
                <p class="error-message">找不到判決內容或發生錯誤。</p>
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 處理文本內容可能包含的HTML標籤
            const judgmentTextElements = document.querySelectorAll('[id^="judgment-text"]');
            judgmentTextElements.forEach(element => {
                // 檢查內容是否含有HTML標籤
                const content = element.innerHTML;
                if (content.trim().length === 0) {
                    element.innerHTML = '<p class="error-message">內容為空</p>';
                }
                
                // 如果內容看起來像HTML但未正確渲染，則用pre標籤包裹
                if (content.includes('&lt;') && content.includes('&gt;')) {
                    const pre = document.createElement('pre');
                    pre.textContent = content;
                    element.innerHTML = '';
                    element.appendChild(pre);
                }
                
                // 檢查文本是否包含亂碼序列
                if (/\\u[\dA-Fa-f]{4}|\\x[\dA-Fa-f]{2}/.test(content)) {
                    try {
                        // 嘗試解析Unicode轉義序列
                        const decoded = JSON.parse('"' + content.replace(/"/g, '\\"') + '"');
                        element.textContent = decoded;
                    } catch (e) {
                        console.error("解析Unicode失敗:", e);
                    }
                }
            });
            
            // 美化JSON顯示
            const jsonElement = document.getElementById('judgment-data');
            if (jsonElement) {
                try {
                    const jsonData = JSON.parse(jsonElement.textContent);
                    const formattedJson = JSON.stringify(jsonData, null, 2);
                    const pre = document.createElement('pre');
                    pre.textContent = formattedJson;
                    jsonElement.innerHTML = '';
                    jsonElement.appendChild(pre);
                } catch (e) {
                    console.error("JSON解析失敗:", e);
                }
            }
        });
    </script>
</body>
</html>